<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Time Calculator</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="/manifest.json">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4157122551548487"
     crossorigin="anonymous"></script>
    <!-- Custom CSS for a professional look with clear light/dark mode and fixed text visibility -->
    <style>
        /* Refined Professional Color Palette:
            Light Mode:
              Body Background: #f5f7fa (Very Light Blue-Grey)
              Container Background: #ffffff (White)
              Primary Accent (Buttons/Headings): #3f51b5 (Indigo)
              Secondary Text/Labels: #546e7a (Blue Grey)
              Input Background: #eceff1 (Light Blue Grey)
              Input Border: #cfd8dc (Lighter Blue Grey)
              Status Box Background: #e8f5e9 (Light Green)
              Status Text: #388e3c (Dark Green)
              Ad Placeholder: #eceff1 (Light Blue Grey)

            Dark Mode:
              Body Background: #2c3e50 (Dark Blue-Grey)
              Container Background: #34495e (Medium Dark Blue-Grey)
              Primary Accent (Buttons/Headings): #64b5f6 (Light Blue)
              Secondary Text/Labels: #b0bec5 (Lighter Blue Grey)
              Input Background: #455a64 (Darker Blue Grey)
              Input Border: #607d8b (Blue Grey)
              Status Box Background: #455a64 (Darker Blue Grey)
              Status Text: #b0bec5 (Lighter Blue Grey)
              Ad Placeholder: #455a64 (Darker Blue Grey)

            Common:
              IN Button: Primary Accent Blue
              OUT Button: Secondary Text/Label Grey
              Break ON: Green
              Break OFF: Red
              Reset Button: Secondary Text/Label Grey
        */

        body {
            font-family: sans-serif;
            background-color: #f5f7fa; /* Very Light Blue-Grey background for light mode */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition */
            color: #263238; /* Default dark text color for light mode */
        }
        .container {
            background-color: #ffffff; /* White card for light mode */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 400px;
            text-align: center;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #3f51b5; /* Indigo for heading */
            transition: color 0.3s ease;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #546e7a; /* Blue Grey for labels */
            text-align: left;
            transition: color 0.3s ease;
        }
        input[type="number"],
        input[type="time"] {
            width: 100%; /* Default width for inputs */
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #cfd8dc; /* Lighter Blue Grey border */
            border-radius: 0.5rem;
            box-sizing: border-box;
            color: #263238; /* Input text color */
            background-color: #eceff1; /* Light Blue Grey input background */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        /* Specific style for shift duration input - now full width */
        #shiftDuration {
            width: 100%; /* Full width */
            text-align: left; /* Default text alignment */
            font-size: 1rem; /* Default font size */
            font-weight: normal; /* Default font weight */
            padding: 0.75rem; /* Default padding */
            margin-bottom: 1rem; /* Default bottom margin */
        }
        input[type="number"]:focus,
        input[type="time"]:focus {
            outline: none;
            border-color: #3f51b5; /* Indigo focus border */
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2); /* Focus ring */
        }
        .input-flex-wrapper { /* New class for input and button wrapper */
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .input-flex-wrapper input {
            flex: 1; /* Make input take available space */
            margin-bottom: 0; /* Remove bottom margin from input inside flex */
        }
        .button-group {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .main-button {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 0.75rem;
            border: none;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            flex: 1;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.2);
        }
        /* Professional Colors for IN/OUT Buttons */
        .btn-in {
            background-color: #3f51b5; /* Indigo */
        }
        .btn-in:hover {
            background-color: #303f9f; /* Darker Indigo */
        }
        .btn-out {
            background-color: #546e7a; /* Blue Grey */
        }
        .btn-out:hover {
            background-color: #37474f; /* Darker Blue Grey */
        }
        .btn-reset {
            background-color: #90a4ae; /* Blue Grey */
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-reset:hover {
            background-color: #78909c; /* Darker Blue Grey */
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.15);
        }
        /* Professional Colors for Break Toggle Button */
        .btn-toggle {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 0.75rem;
            border: none;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-toggle.on {
            background-color: #4CAF50; /* Green for ON */
        }
        .btn-toggle.on:hover {
            background-color: #388E3C; /* Darker Green */
        }
        .btn-toggle.off {
            background-color: #f44336; /* Red for OFF */
        }
        .btn-toggle.off:hover {
            background-color: #d32f2f; /* Darker Red */
        }
        .status-box {
            background-color: #e8f5e9; /* Light Green for status box */
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 2rem;
            color: #388e3c; /* Dark Green text */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .status-box p {
            margin-bottom: 0.5rem;
            color: #388e3c; /* Dark Green text */
            transition: color 0.3s ease;
        }
        /* Increased font size for status and leaving time */
        .status-box .display-text {
            font-size: 2rem; /* Increased from 1.5rem */
            font-weight: bold;
            color: #1b5e20; /* Even darker green */
            transition: color 0.3s ease;
        }
        .status-box .large-text {
            font-size: 3rem; /* Increased from 2.5rem */
            font-weight: bolder;
            color: #1b5e20;
            transition: color 0.3s ease;
        }
        .ad-placeholder {
            background-color: #eceff1; /* Light Blue Grey for ads */
            border: 1px dashed #cfd8dc; /* Dashed border */
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            color: #546e7a; /* Blue Grey text */
            font-size: 0.9rem;
            margin-top: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .hidden {
            display: none;
        }

        /* Dark mode styles */
        body.dark {
            background-color: #2c3e50; /* Dark Blue-Grey background */
            color: #e0e0e0; /* Light text */
        }
        body.dark .container {
            background-color: #34495e; /* Medium Dark Blue-Grey card */
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        body.dark h1 {
            color: #64b5f6; /* Light Blue for heading */
        }
        body.dark label {
            color: #b0bec5; /* Lighter Blue Grey for labels */
        }
        /* Fix for Break Status and Timer text in dark mode */
        body.dark .break-status-text { /* New class for Break Status label */
            color: #e0e0e0; /* White text */
        }
        body.dark #breakTimer { /* Direct ID for timer */
            color: #e0e0e0; /* White text */
        }
        /* Fix for Total Break text in dark mode */
        body.dark #totalBreakTimeDisplay {
            color: #e0e0e0; /* White text */
        }


        body.dark input[type="number"],
        body.dark input[type="time"] {
            background-color: #455a64; /* Darker Blue Grey input background */
            color: #e0e0e0;
            border-color: #607d8b;
        }
        body.dark input[type="number"]:focus,
        body.dark input[type="time"]:focus {
            border-color: #64b5f6;
            box-shadow: 0 0 0 2px rgba(100, 181, 246, 0.3);
        }
        body.dark .main-button {
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        body.dark .main-button:hover {
            box-shadow: 0 6px 10px rgba(0,0,0,0.4);
        }
        body.dark .btn-in {
            background-color: #64b5f6; /* Light Blue for IN */
        }
        body.dark .btn-in:hover {
            background-color: #42a5f5;
        }
        body.dark .btn-out {
            background-color: #90a4ae; /* Blue Grey for OUT */
        }
        body.dark .btn-out:hover {
            background-color: #78909c;
        }
        body.dark .btn-reset {
            background-color: #90a4ae; /* Blue Grey for Reset */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        body.dark .btn-reset:hover {
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
        }
        body.dark .btn-toggle {
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        body.dark .btn-toggle.on {
            background-color: #66bb6a; /* Green for ON */
        }
        body.dark .btn-toggle.on:hover {
            background-color: #43a047;
        }
        body.dark .btn-toggle.off {
            background-color: #ef5350; /* Red for OFF */
        }
        body.dark .btn-toggle.off:hover {
            background-color: #e53935;
        }
        body.dark .status-box {
            background-color: #455a64; /* Darker Blue Grey for status box */
            color: #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        body.dark .status-box p {
            color: #b0bec5;
        }
        body.dark .status-box .display-text,
        body.dark .status-box .large-text {
            color: #64b5f6;
        }
        body.dark .ad-placeholder {
            background-color: #455a64; /* Darker Blue Grey for ads */
            border-color: #607d8b;
            color: #b0bec5;
        }
        body.dark #darkModeToggle {
            background-color: #607d8b; /* Blue Grey for toggle button */
            color: #e0e0e0;
        }
        /* Reports Section specific styles */
        #reportsSection {
            background-color: var(--container-bg); /* Use CSS variables for consistent theme */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 400px;
            text-align: center;
            margin-top: 2rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            color: var(--secondary-text); /* Ensure general text color applies */
        }
        #reportsSection h2 {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            color: var(--primary-accent);
        }
        #reportsList {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 300px; /* Make it scrollable if many reports */
            overflow-y: auto;
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            background-color: var(--input-bg);
            padding: 0.5rem;
        }
        #reportsList li {
            background-color: var(--body-bg); /* Lighter background for list items */
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: left;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: 0.9rem;
            color: var(--secondary-text-label); /* Use a consistent text color for list items */
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        #reportsList li strong {
            color: var(--primary-accent);
        }
        #reportsList li span {
            font-size: 0.85rem;
            color: var(--secondary-text-label);
        }
        #reportsList li:last-child {
            margin-bottom: 0;
        }
        #noReportsMessage {
            color: var(--secondary-text-label);
            font-style: italic;
            margin-top: 1rem;
        }
        #clearAllReportsBtn {
            background-color: #f44336; /* Red for danger action */
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-top: 1.5rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        #clearAllReportsBtn:hover {
            background-color: #d32f2f;
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.15);
        }

        /* Dark mode specific for reports section */
        body.dark #reportsSection {
            background-color: #34495e; /* Medium Dark Blue-Grey card */
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            color: #e0e0e0;
        }
        body.dark #reportsSection h2 {
            color: #64b5f6; /* Light Blue for heading */
        }
        body.dark #reportsList {
            border-color: #607d8b;
            background-color: #455a64; /* Darker Blue Grey input background */
        }
        body.dark #reportsList li {
            background-color: #2c3e50; /* Dark Blue-Grey background */
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            color: #b0bec5;
        }
        body.dark #reportsList li strong {
            color: #64b5f6;
        }
        body.dark #reportsList li span {
            color: #b0bec5;
        }
        body.dark #clearAllReportsBtn {
            background-color: #ef5350; /* Lighter Red for dark mode */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        body.dark #clearAllReportsBtn:hover {
            background-color: #e53935;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
        }

        /* CSS Variables for easier theme management in JS */
        :root {
            --body-bg: #f5f7fa;
            --container-bg: #ffffff;
            --primary-accent: #3f51b5;
            --secondary-text: #546e7a;
            --secondary-text-label: #546e7a; /* Added for clarity */
            --input-bg: #eceff1;
            --input-border: #cfd8dc;
        }

        body.dark {
            --body-bg: #2c3e50;
            --container-bg: #34495e;
            --primary-accent: #64b5f6;
            --secondary-text: #e0e0e0;
            --secondary-text-label: #b0bec5; /* Changed for dark mode */
            --input-bg: #455a64;
            --input-border: #607d8b;
        }

        /* View Reports button styling */
        #viewReportsBtn {
            background-color: #3f51b5; /* Light mode: Same as IN button */
            color: white;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #viewReportsBtn:hover {
            background-color: #303f9f; /* Light mode hover */
        }

        body.dark #viewReportsBtn {
            background-color: #64b5f6; /* Dark mode: Same as IN button */
            color: white;
        }
        body.dark #viewReportsBtn:hover {
            background-color: #42a5f5; /* Dark mode hover */
        }

        /* Small date text styling */
        .small-date-text {
            font-size: 0.75rem; /* Choti si font size */
            color: #546e7a; /* Light mode mein blue-grey */
            transition: color 0.3s ease;
        }

        body.dark .small-date-text {
            color: #b0bec5; /* Dark mode mein lighter blue-grey */
        }

        /* Scroll message styling */
        #scrollMessage {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            font-size: 0.9rem;
            opacity: 0;
            visibility: hidden; /* Control visibility with this */
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out; /* Add visibility to transition */
        }
        #scrollMessage.visible {
            opacity: 1;
            visibility: visible; /* Make it visible */
        }

        /* Message box styling (for showMessage and showConfirmation) */
        .custom-message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            color: var(--secondary-text);
            font-weight: bold;
            max-width: 80%;
        }
        .custom-message-box button {
            margin-top: 15px;
            padding: 8px 15px;
            background-color: var(--primary-accent);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .custom-message-box #confirmYes {
            background-color: #4CAF50;
            margin-right: 10px;
        }
        .custom-message-box #confirmNo {
            background-color: #f44336;
        }

        /* Filter and Sort controls styling */
        .filter-sort-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: var(--input-bg);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .filter-sort-controls label {
            font-weight: normal;
            color: var(--secondary-text-label);
            margin-bottom: 0;
            text-align: center;
        }

        .filter-sort-controls select,
        .filter-sort-controls input[type="date"] {
            flex: 1;
            min-width: 120px; /* Ensure inputs don't get too small */
            padding: 0.5rem;
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            background-color: var(--container-bg); /* Use container bg for these inputs */
            color: var(--secondary-text);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .filter-sort-controls select:focus,
        .filter-sort-controls input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
        }

        .filter-sort-controls button {
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 0.5rem;
            border: none;
            color: white;
            background-color: #3f51b5; /* Primary accent for apply button */
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filter-sort-controls button:hover {
            background-color: #303f9f;
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.15);
        }

        body.dark .filter-sort-controls select,
        body.dark .filter-sort-controls input[type="date"] {
            background-color: #34495e; /* Darker background for inputs in dark mode */
            color: #e0e0e0;
            border-color: #607d8b;
        }
        body.dark .filter-sort-controls button {
            background-color: #64b5f6; /* Light blue for dark mode apply button */
        }
        body.dark .filter-sort-controls button:hover {
            background-color: #42a5f5;
        }

        /* Notification settings styling */
        .notification-settings {
            background-color: var(--input-bg);
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 1.5rem;
            text-align: left;
            color: var(--secondary-text-label);
        }

        .notification-settings div {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .notification-settings label {
            margin-bottom: 0;
            margin-right: 10px;
            font-weight: normal;
        }

        .notification-settings input[type="checkbox"] {
            margin-right: 5px;
            width: auto; /* Override full width */
            margin-bottom: 0; /* Override margin-bottom */
        }

        .notification-settings input[type="number"] {
            width: 80px; /* Smaller width for minutes input */
            margin-bottom: 0; /* Override margin-bottom */
            text-align: center;
        }

        body.dark .notification-settings {
            background-color: #455a64;
            color: #b0bec5;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-content-center min-h-screen p-4">
    <div class="container">
        <h1>Office Time Calculator</h1>

        <!-- Dark Mode Toggle Button and View Reports Button in a flex container -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <!-- View Reports Button (Moved here) -->
            <button id="viewReportsBtn" class="btn-reset">
                View Reports
            </button>
            <!-- Dark Mode Toggle Button -->
            <button id="darkModeToggle" style="background-color: #cfd8dc; color: #546e7a; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease, color 0.3s ease;">
                <span id="darkModeIcon">🌙</span>
            </button>
        </div>


        <!-- Shift Duration Input -->
        <div style="margin-bottom: 1.5rem;">
            <label for="shiftDuration">Your Shift Duration (in hours):</label>
            <input type="number" id="shiftDuration" value="9" min="1" max="12">
        </div>

        <!-- Manual IN Time Input with Reset Button -->
        <div style="margin-bottom: 1.5rem;"> <!-- Wrapper div for margin -->
            <label for="manualInTime">Manual IN Time (Optional):</label>
            <div class="input-flex-wrapper"> <!-- New wrapper for input and button -->
                <input type="time" id="manualInTime">
                <button id="resetManualInTimeBtn" class="btn-reset">Reset</button>
            </div>
        </div>

        <!-- IN/OUT Buttons -->
        <div class="button-group">
            <button id="inBtn" class="main-button btn-in">IN</button>
            <button id="outBtn" class="main-button btn-out" disabled>OUT</button>
        </div>

        <!-- Break Toggle Button -->
        <div style="margin-bottom: 1.5rem; text-align: center;">
            <p class="break-status-text" style="margin-bottom: 0.5rem; font-weight: bold;">Break Status:</p>
            <button id="breakToggleBtn" class="btn-toggle off" disabled>
                Break OFF
            </button>
            <p id="breakTimer" style="font-size: 1.2rem; font-weight: bold; margin-top: 0.75rem; display: none;">00:00:00</p>
        </div>

        <!-- Current Status / Leaving Time Display -->
        <div class="status-box">
            <p style="font-weight: bold; margin-bottom: 0.5rem;">Current Status:</p>
            <p><span id="inDateDisplay" class="small-date-text">-- -- --</span><br>
               <span id="statusDisplay" class="display-text">Press IN to start</span></p>
            
            <p style="font-weight: bold; margin-bottom: 0.5rem;">Estimated Leaving Time:</p>
            <p><span id="outDateDisplay" class="small-date-text">-- -- --</span><br>
               <span id="leavingTimeDisplay" class="large-text">--:-- --</span></p>
            <p id="totalBreakTimeDisplay" style="font-size: 0.9rem; margin-top: 0.5rem; display: none;">Total Break: 0 minutes</p>
        </div>

        <!-- Notification Settings (New Section) -->
        <div class="notification-settings">
            <h3>Notification Settings</h3>
            <div>
                <input type="checkbox" id="enableNotificationsCheckbox">
                <label for="enableNotificationsCheckbox">Enable Notifications</label>
            </div>
            <div>
                <label for="reminderMinutesInput">Remind me</label>
                <input type="number" id="reminderMinutesInput" value="15" min="1" max="60" disabled>
                <span>minutes before leaving</span>
            </div>
        </div>

    </div>

    <!-- Reports Section (New) -->
    <div id="reportsSection" class="container hidden">
        <h2>Daily Work Reports</h2>

        <!-- Filter and Sort Controls -->
        <div class="filter-sort-controls">
            <label for="sortReports">Sort by:</label>
            <select id="sortReports">
                <option value="dateDesc">Date (Newest First)</option>
                <option value="dateAsc">Date (Oldest First)</option>
                <option value="workDurationDesc">Actual Work (Longest First)</option>
                <option value="workDurationAsc">Actual Work (Shortest First)</option>
            </select>

            <label for="filterStartDate">From:</label>
            <input type="date" id="filterStartDate">

            <label for="filterEndDate">To:</label>
            <input type="date" id="filterEndDate">

            <button id="applyFilterSortBtn">Apply</button>
        </div>

        <ul id="reportsList">
            <li id="noReportsMessage">No reports yet.</li>
        </ul>
        <button id="clearAllReportsBtn">Clear All Reports</button>
        <button id="exportReportsBtn" class="btn-reset" style="background-color: #4CAF50; margin-top: 1rem;">Export to CSV</button>
    </div>

    <!-- Banner Ad Placeholders -->
    <div class="ad-placeholder">
        <p> <amp-ad width="100vw" height="320"
     type="adsense"
     data-ad-client="ca-pub-4157122551548487"
     data-ad-slot="2380393310"
     data-auto-format="mcrspv"
     data-full-width="">
  <div overflow=""></div>
</amp-ad> </p>
      <!-- <p style="font-size: 0.75rem; color: #546e7a;">This is an ad placement.</p> -->
    </div>
    <div class="ad-placeholder">
        <p><amp-ad width="100vw" height="320"
     type="adsense"
     data-ad-client="ca-pub-4157122551548487"
     data-ad-slot="7097533371"
     data-auto-format="rspv"
     data-full-width="">
  <div overflow=""></div>
</amp-ad></p>
        <!-- <p style="font-size: 0.75rem; color: #546e7a;">This is an ad placement.</p> -->
    </div>
    <div class="ad-placeholder">
        <p><amp-ad width="100vw" height="320"
     type="adsense"
     data-ad-client="ca-pub-4157122551548487"
     data-ad-slot="8954923417"
     data-auto-format="mcrspv"
     data-full-width="">
  <div overflow=""></div>
</amp-ad></p>
        <!-- <p style="font-size: 0.75rem; color: #546e7a;">This is an ad placement.</p> -->
    </div>

    <!-- Scroll Message (New) -->
    <div id="scrollMessage">
        Scroll down to view reports
    </div>
<script async custom-element="amp-ad" src="https://cdn.ampproject.org/v0/amp-ad-0.1.js"></script>
    <script>
        // DOM elements ko get karein
        const shiftDurationInput = document.getElementById('shiftDuration');
        const manualInTimeInput = document.getElementById('manualInTime');
        const resetManualInTimeBtn = document.getElementById('resetManualInTimeBtn');
        const inBtn = document.getElementById('inBtn');
        const outBtn = document.getElementById('outBtn');
        const breakToggleBtn = document.getElementById('breakToggleBtn');
        const breakTimerDisplay = document.getElementById('breakTimer');
        const statusDisplay = document.getElementById('statusDisplay');
        const leavingTimeDisplay = document.getElementById('leavingTimeDisplay');
        const totalBreakTimeDisplay = document.getElementById('totalBreakTimeDisplay');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const body = document.body;
        const darkModeIcon = document.getElementById('darkModeIcon'); // Dark Mode Icon element

        // Reports ke liye naye elements
        const viewReportsBtn = document.getElementById('viewReportsBtn');
        const reportsSection = document.getElementById('reportsSection');
        const reportsList = document.getElementById('reportsList');
        const noReportsMessage = document.getElementById('noReportsMessage');
        const clearAllReportsBtn = document.getElementById('clearAllReportsBtn');
        const exportReportsBtn = document.getElementById('exportReportsBtn'); // Export button

        // Date display elements
        const inDateDisplay = document.getElementById('inDateDisplay');
        const outDateDisplay = document.getElementById('outDateDisplay');

        // Scroll message element
        const scrollMessage = document.getElementById('scrollMessage');

        // Filter and Sort elements
        const sortReportsSelect = document.getElementById('sortReports'); // Sort dropdown
        const filterStartDateInput = document.getElementById('filterStartDate'); // Filter start date
        const filterEndDateInput = document.getElementById('filterEndDate'); // Filter end date
        const applyFilterSortBtn = document.getElementById('applyFilterSortBtn'); // Apply filter/sort button

        // Notification elements (New)
        const enableNotificationsCheckbox = document.getElementById('enableNotificationsCheckbox');
        const reminderMinutesInput = document.getElementById('reminderMinutesInput');


        // App state store karne ke liye variables
        let inTime = null;
        let breakStartTime = null;
        let totalBreakDurationMinutes = 0;
        let breakInterval = null;
        let isBreakOn = false;
        let currentShiftOutTime = null; // Yeh estimated leaving time hai
        let isDarkMode = false;
        let dailyReports = []; // Daily reports store karne ke liye array
        let enableNotifications = false; // New: Notification preference
        let reminderMinutesBeforeOut = 15; // New: Reminder minutes
        let notificationSentForCurrentShift = false; // New: Track if notification has been sent


        // --- Utility Functions ---

        // Sirf time ko HH:MM AM/PM format mein format karein
        function formatTime(date) {
            if (!date) return '--:-- --';
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 === 0 ? 12 : hours % 12;
            const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
            return `${formattedHours}:${formattedMinutes} ${ampm}`;
        }

        // Sirf date ko "MMM DD, YYYY" format mein format karein
        function formatOnlyDate(date) {
            if (!date) return '-- -- --';
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            };
            return date.toLocaleString('en-US', options);
        }

        // Date aur time ko "MMM DD, YYYY, HH:MM AM/PM" format mein format karein (Reports ke liye)
        function formatDateTime(date) {
            if (!date) return '--:-- --';
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            return date.toLocaleString('en-US', options);
        }

        // Total seconds ko HH:MM:SS format mein format karein
        function formatDuration(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const pad = (num) => num < 10 ? '0' + num : num;
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }

        // --- Local Storage Functions ---

        // App state ko Local Storage mein save karein
        function saveState() {
            const state = {
                inTime: inTime ? inTime.toISOString() : null,
                totalBreakDurationMinutes: totalBreakDurationMinutes,
                isBreakOn: isBreakOn,
                breakStartTime: breakStartTime ? breakStartTime.toISOString() : null,
                shiftDuration: parseFloat(shiftDurationInput.value),
                currentShiftOutTime: currentShiftOutTime ? currentShiftOutTime.toISOString() : null,
                manualInTimeValue: manualInTimeInput.value,
                isDarkMode: isDarkMode,
                enableNotifications: enableNotifications, // Save notification preference
                reminderMinutesBeforeOut: reminderMinutesInput.value, // Save reminder minutes
                notificationSentForCurrentShift: notificationSentForCurrentShift // Save notification sent status
            };
            localStorage.setItem('officeTimeCalculatorState', JSON.stringify(state));
            localStorage.setItem('officeTimeCalculatorDailyReports', JSON.stringify(dailyReports)); // Reports bhi save karein
        }

        // App state ko Local Storage se load karein
        function loadState() {
            const savedState = localStorage.getItem('officeTimeCalculatorState');
            if (savedState) {
                const state = JSON.parse(savedState);
                inTime = state.inTime ? new Date(state.inTime) : null;
                totalBreakDurationMinutes = state.totalBreakDurationMinutes || 0;
                isBreakOn = state.isBreakOn || false;
                breakStartTime = state.breakStartTime ? new Date(state.breakStartTime) : null;
                shiftDurationInput.value = state.shiftDuration || 9;
                currentShiftOutTime = state.currentShiftOutTime ? new Date(state.currentShiftOutTime) : null;
                manualInTimeInput.value = state.manualInTimeValue || '';
                isDarkMode = state.isDarkMode || false;
                enableNotifications = state.enableNotifications || false; // Load notification preference
                reminderMinutesInput.value = state.reminderMinutesBeforeOut || 15; // Load reminder minutes
                notificationSentForCurrentShift = state.notificationSentForCurrentShift || false; // Load notification sent status


                // Reports load karein
                const savedReports = localStorage.getItem('officeTimeCalculatorDailyReports');
                dailyReports = savedReports ? JSON.parse(savedReports) : [];


                // Loaded state ke hisaab se UI update karein
                updateUI();
                if (isBreakOn) {
                    startBreakTimer();
                }
                // Load hone par dark mode apply karein
                if (isDarkMode) {
                    body.classList.add('dark');
                    darkModeIcon.textContent = '☀️'; // Sun icon for dark mode
                } else {
                    body.classList.remove('dark');
                    darkModeIcon.textContent = '🌙'; // Moon icon for light mode
                }

                // Update notification UI based on loaded state
                enableNotificationsCheckbox.checked = enableNotifications;
                reminderMinutesInput.disabled = !enableNotifications;
            } else {
                // Agar koi saved state nahi hai, toh UI ko default state mein rakhein
                updateUI();
            }
            renderReports(); // Reports ko load hone par render karein
        }

        // --- Core Logic Functions ---

        // UI ko current state ke hisaab se update karein
        function updateUI() {
            console.log('updateUI called. isBreakOn:', isBreakOn); // Debugging log
            if (inTime) {
                inDateDisplay.textContent = formatOnlyDate(inTime); // IN Date update karein
                statusDisplay.textContent = `IN at: ${formatTime(inTime)}`; // Sirf IN Time update karein
                inBtn.disabled = true;
                inBtn.style.opacity = '0.5'; // Basic disabled styling
                inBtn.style.cursor = 'not-allowed';
                outBtn.disabled = false;
                outBtn.style.opacity = '1';
                outBtn.style.cursor = 'pointer';
                breakToggleBtn.disabled = false;
                breakToggleBtn.style.opacity = '1';
                breakToggleBtn.style.cursor = 'pointer';
                manualInTimeInput.disabled = true;
                resetManualInTimeBtn.disabled = true;
                resetManualInTimeBtn.style.opacity = '0.5';
                resetManualInTimeBtn.style.cursor = 'not-allowed';
            } else {
                inDateDisplay.textContent = '-- -- --'; // IN Date reset karein
                statusDisplay.textContent = 'Press IN to start';
                inBtn.disabled = false;
                inBtn.style.opacity = '1';
                inBtn.style.cursor = 'pointer';
                outBtn.disabled = true;
                outBtn.style.opacity = '0.5';
                outBtn.style.cursor = 'not-allowed';
                breakToggleBtn.disabled = true;
                breakToggleBtn.style.opacity = '0.5';
                breakToggleBtn.style.cursor = 'not-allowed';
                manualInTimeInput.disabled = false;
                if (manualInTimeInput.value) {
                    resetManualInTimeBtn.disabled = false;
                    resetManualInTimeBtn.style.opacity = '1';
                    resetManualInTimeBtn.style.cursor = 'pointer';
                } else {
                    resetManualInTimeBtn.disabled = true;
                    resetManualInTimeBtn.style.opacity = '0.5';
                    resetManualInTimeBtn.style.cursor = 'not-allowed';
                }
            }

            // Break button styling aur text update karein
            if (isBreakOn) {
                breakToggleBtn.classList.remove('off');
                breakToggleBtn.classList.add('on');
                breakToggleBtn.textContent = 'Break ON';
                breakTimerDisplay.style.display = 'block'; /* Timer dikhayein */
            } else {
                breakToggleBtn.classList.remove('on');
                breakToggleBtn.classList.add('off');
                breakToggleBtn.textContent = 'Break OFF';
                breakTimerDisplay.style.display = 'none'; /* Timer chhupayein */
            }

            updateLeavingTime();
        }

        // Leaving time calculate aur update karein
        function updateLeavingTime() {
            console.log('updateLeavingTime called. totalBreakDurationMinutes:', totalBreakDurationMinutes); // Debugging log
            if (!inTime) {
                outDateDisplay.textContent = '-- -- --'; // OUT Date reset karein
                leavingTimeDisplay.textContent = '--:-- --';
                totalBreakTimeDisplay.style.display = 'none'; /* Chhupayein */
                currentShiftOutTime = null;
                saveState();
                return;
            }

            const shiftHours = parseFloat(shiftDurationInput.value) || 9;
            const requiredShiftMinutes = shiftHours * 60;

            let currentTotalBreak = totalBreakDurationMinutes;
            if (isBreakOn && breakStartTime) {
                const currentBreakElapsedMs = Date.now() - breakStartTime.getTime();
                currentTotalBreak += currentBreakElapsedMs / (1000 * 60);
            }

            const totalMinutesNeeded = requiredShiftMinutes + currentTotalBreak;
            const leavingDate = new Date(inTime.getTime() + totalMinutesNeeded * 60 * 1000);
            currentShiftOutTime = leavingDate; // Estimated leaving time update karein

            outDateDisplay.textContent = formatOnlyDate(leavingDate); // OUT Date update karein
            leavingTimeDisplay.textContent = formatTime(leavingDate); // Sirf Leaving Time update karein
            totalBreakTimeDisplay.textContent = `Total Break: ${Math.round(currentTotalBreak)} minutes`;
            totalBreakTimeDisplay.style.display = 'block'; /* Dikhayein */

            // Check for notifications (New)
            checkNotificationReminder();

            saveState();
        }

        // Break timer ko update karein
        function startBreakTimer() {
            console.log('startBreakTimer called.'); // Debugging log
            if (breakInterval) {
                clearInterval(breakInterval);
            }
            breakInterval = setInterval(() => {
                if (breakStartTime) {
                    const currentBreakElapsedSeconds = (Date.now() - breakStartTime.getTime()) / 1000;
                    breakTimerDisplay.textContent = formatDuration(currentBreakElapsedSeconds);
                    console.log('Break Timer Update:', formatDuration(currentBreakElapsedSeconds)); // Debugging log
                    updateLeavingTime(); // Har second leaving time update karein
                }
            }, 1000);
        }

        // --- Notifications Functions ---

        // Notification permission request karein
        async function requestNotificationPermission() {
            if (!("Notification" in window)) {
                showMessage("This browser does not support desktop notification.");
                return false;
            }

            if (Notification.permission === "granted") {
                return true;
            }

            if (Notification.permission === "denied") {
                showMessage("Notification permission was denied. Please enable it in your browser settings to receive reminders.");
                return false;
            }

            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                showMessage("Notification permission granted!");
                return true;
            } else {
                showMessage("Notification permission denied.");
                return false;
            }
        }

        // Notification display karein
        function sendNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, { body: body, icon: '/icons/icon-192x192.png' }); // PWA icon use karein
            }
        }

        // Check karein ki notification reminder send karna hai ya nahi
        function checkNotificationReminder() {
            if (!inTime || !enableNotifications || notificationSentForCurrentShift || !currentShiftOutTime) {
                return; // Agar IN time nahi hai, notifications disabled hain, ya already sent, toh kuch na karein
            }

            const now = new Date();
            const reminderTimeMs = currentShiftOutTime.getTime() - (reminderMinutesInput.value * 60 * 1000);

            // Check if current time is past the reminder time, but before the actual estimated leaving time
            if (now.getTime() >= reminderTimeMs && now.getTime() < currentShiftOutTime.getTime()) {
                sendNotification(
                    "Office Time Reminder!",
                    `Your estimated leaving time is ${formatTime(currentShiftOutTime)}. Only ${reminderMinutesInput.value} minutes left!`
                );
                notificationSentForCurrentShift = true; // Mark as sent for this shift
                saveState(); // Save the updated status
            }
        }


        // --- Reports Functions ---

        // Daily report add karein
        function addReport(actualOutTime) { // actualOutTime parameter add kiya
            if (!inTime) return; // Agar IN time nahi hai, toh report add na karen

            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0]; // YYYY-MM-DD format

            // Actual work duration calculate karein
            const inTimeMs = inTime.getTime();
            const outTimeMs = actualOutTime.getTime(); // Actual OUT time use karein
            const totalShiftMs = outTimeMs - inTimeMs; // Total time from IN to actual OUT
            const totalBreakMs = totalBreakDurationMinutes * 60 * 1000;
            
            let actualWorkMs = totalShiftMs - totalBreakMs;
            // Ensure actual work is not negative
            if (actualWorkMs < 0) {
                actualWorkMs = 0;
            }
            const actualWorkDurationMinutes = Math.round(actualWorkMs / (1000 * 60));


            const newReport = {
                date: formattedDate,
                inTime: formatDateTime(inTime), // formatDateTime use karein
                outTime: formatDateTime(actualOutTime), // formatDateTime use karein
                shiftDurationHours: parseFloat(shiftDurationInput.value),
                totalBreakMinutes: Math.round(totalBreakDurationMinutes),
                actualWorkDurationMinutes: actualWorkDurationMinutes, // Corrected actual work duration
            };

            // Check karein ki aaj ki report pehle se hai ya nahi, agar hai toh update karein
            const existingReportIndex = dailyReports.findIndex(report => report.date === formattedDate);
            if (existingReportIndex > -1) {
                dailyReports[existingReportIndex] = newReport; // Existing report update karein
            } else {
                dailyReports.push(newReport); // Nayi report add karein
            }
            saveState();
            renderReports();
        }

        // Reports list render karein
        function renderReports() {
            reportsList.innerHTML = ''; // Existing list clear karein

            let reportsToRender = [...dailyReports]; // Create a copy to filter/sort

            // Apply Date Filtering
            const startDate = filterStartDateInput.value ? new Date(filterStartDateInput.value) : null;
            const endDate = filterEndDateInput.value ? new Date(filterEndDateInput.value) : null;

            if (startDate || endDate) {
                reportsToRender = reportsToRender.filter(report => {
                    const reportDate = new Date(report.date);
                    reportDate.setHours(0, 0, 0, 0); // Normalize to start of day for comparison
                    if (startDate && reportDate < startDate) return false;
                    if (endDate && reportDate > endDate) return false;
                    return true;
                });
            }

            // Apply Sorting
            const sortOption = sortReportsSelect.value;
            reportsToRender.sort((a, b) => {
                if (sortOption === 'dateDesc') {
                    return new Date(b.date) - new Date(a.date);
                } else if (sortOption === 'dateAsc') {
                    return new Date(a.date) - new Date(b.date);
                } else if (sortOption === 'workDurationDesc') {
                    return b.actualWorkDurationMinutes - a.actualWorkDurationMinutes;
                } else if (sortOption === 'workDurationAsc') {
                    return a.actualWorkDurationMinutes - b.actualWorkDurationMinutes;
                }
                return 0; // Default no sort
            });


            if (reportsToRender.length === 0) {
                noReportsMessage.style.display = 'block'; // "No reports yet." message dikhayein
                reportsList.appendChild(noReportsMessage); // List ke andar rakhein styling ke liye
                clearAllReportsBtn.disabled = true;
                clearAllReportsBtn.style.opacity = '0.5';
                clearAllReportsBtn.style.cursor = 'not-allowed';
                exportReportsBtn.disabled = true; // Disable export if no reports
                exportReportsBtn.style.opacity = '0.5';
                exportReportsBtn.style.cursor = 'not-allowed';
            } else {
                noReportsMessage.style.display = 'none'; // "No reports yet." message chhupayein
                clearAllReportsBtn.disabled = false;
                clearAllReportsBtn.style.opacity = '1';
                clearAllReportsBtn.style.cursor = 'pointer';
                exportReportsBtn.disabled = false; // Enable export
                exportReportsBtn.style.opacity = '1';
                exportReportsBtn.style.cursor = 'pointer';


                reportsToRender.forEach(report => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <strong>Date: ${report.date}</strong><br>
                        <span>IN: ${report.inTime}, OUT: ${report.outTime}</span><br>
                        <span>Shift: ${report.shiftDurationHours} hrs, Break: ${report.totalBreakMinutes} mins</span><br>
                        <span>Actual Work: ${report.actualWorkDurationMinutes} mins</span>
                    `;
                    reportsList.appendChild(listItem);
                });
            }
        }

        // Saare reports clear karein
        function clearAllReports() {
            // Custom confirmation box use karein
            showConfirmation('Are you sure you want to delete ALL daily work reports? This action cannot be undone.', () => {
                dailyReports = [];
                saveState();
                renderReports();
                showMessage('All reports have been deleted.');
            });
        }

        // Reports ko CSV format mein export karein
        function exportReportsToCSV() {
            if (dailyReports.length === 0) {
                showMessage('No reports to export.');
                return;
            }

            const headers = ["Date", "IN Time", "OUT Time", "Shift Duration (hours)", "Total Break (minutes)", "Actual Work (minutes)"];
            const rows = dailyReports.map(report => [
                report.date,
                report.inTime,
                report.outTime,
                report.shiftDurationHours,
                report.totalBreakMinutes,
                report.actualWorkDurationMinutes
            ]);

            let csvContent = headers.join(",") + "\n";
            rows.forEach(row => {
                csvContent += row.map(e => `"${e}"`).join(",") + "\n"; // Quote values to handle commas in data
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // Feature detection for download attribute
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "office_time_reports.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showMessage('Your browser does not support downloading files directly. Please copy the data manually.');
            }
        }


        // --- Custom Message Box Functions (Replacing alert/confirm) ---
        let currentMessageBox = null; // Track the currently displayed message box

        // Custom message box dikhane ke liye
        function showMessage(message) {
            if (currentMessageBox) {
                // Agar pehle se koi message box hai, toh uska content update karein
                currentMessageBox.querySelector('p').textContent = message;
                currentMessageBox.style.display = 'block'; // Ensure it's visible
                return;
            }

            const messageBox = document.createElement('div');
            messageBox.classList.add('custom-message-box'); // Add a class for styling
            messageBox.innerHTML = `
                <p>${message}</p>
                <button>OK</button>
            `;
            document.body.appendChild(messageBox);
            currentMessageBox = messageBox; // Store reference to the new message box

            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
                currentMessageBox = null; // Clear the reference
            });
        }

        // Custom confirmation box dikhane ke liye
        function showConfirmation(message, onConfirm) {
            if (currentMessageBox) {
                // Agar pehle se koi message box hai, toh use hata dein
                document.body.removeChild(currentMessageBox);
                currentMessageBox = null;
            }

            const confirmationBox = document.createElement('div');
            confirmationBox.classList.add('custom-message-box'); // Add a class for styling
            confirmationBox.innerHTML = `
                <p>${message}</p>
                <div style="margin-top: 15px;">
                    <button id="confirmYes" style="background-color: #4CAF50;">Yes</button>
                    <button id="confirmNo" style="background-color: #f44336;">No</button>
                </div>
            `;
            document.body.appendChild(confirmationBox);
            currentMessageBox = confirmationBox; // Store reference

            confirmationBox.querySelector('#confirmYes').addEventListener('click', () => {
                document.body.removeChild(confirmationBox);
                currentMessageBox = null;
                onConfirm();
            });

            confirmationBox.querySelector('#confirmNo').addEventListener('click', () => {
                document.body.removeChild(confirmationBox);
                currentMessageBox = null;
            });
        }


        // --- Event Handlers ---

        // IN button click handler
        inBtn.addEventListener('click', () => {
            console.log('IN button clicked.'); // Debugging log
            let startTime = new Date();
            if (manualInTimeInput.value) {
                const [hours, minutes] = manualInTimeInput.value.split(':').map(Number);
                startTime.setHours(hours, minutes, 0, 0);
            }
            inTime = startTime;
            totalBreakDurationMinutes = 0;
            notificationSentForCurrentShift = false; // Reset notification status for new shift
            updateUI();
            saveState();
        });

        // OUT button click handler
        outBtn.addEventListener('click', () => {
            console.log('OUT button clicked.'); // Debugging log
            if (isBreakOn) {
                toggleBreak(); // Break ko end karein OUT karne se pehle
            }
            
            const actualOutTime = new Date(); // Actual OUT time capture karein
            addReport(actualOutTime); // Report add karein actual OUT time ke saath

            // Naye din ke liye state reset karein
            inTime = null;
            totalBreakDurationMinutes = 0;
            currentShiftOutTime = null;
            manualInTimeInput.value = '';
            notificationSentForCurrentShift = false; // Reset notification status
            updateUI();
            saveState();
        });

        // Break toggle handler
        function toggleBreak() {
            console.log('toggleBreak called. Current isBreakOn:', isBreakOn); // Debugging log
            if (isBreakOn) {
                // Break OFF ho raha hai
                const breakEndTime = new Date();
                const elapsedBreakMs = breakEndTime.getTime() - breakStartTime.getTime();
                totalBreakDurationMinutes += elapsedBreakMs / (1000 * 60);
                console.log('Break OFF. Elapsed break (minutes):', elapsedBreakMs / (1000 * 60)); // Debugging log
                console.log('New totalBreakDurationMinutes:', totalBreakDurationMinutes); // Debugging log

                clearInterval(breakInterval);
                breakInterval = null;
                breakStartTime = null;
                isBreakOn = false;
            } else {
                // Break ON ho raha hai
                breakStartTime = new Date();
                isBreakOn = true;
                startBreakTimer();
                console.log('Break ON. Break start time:', breakStartTime); // Debugging log
            }
            updateUI();
            saveState();
        }
        breakToggleBtn.addEventListener('click', toggleBreak);

        // Shift duration change hone par leaving time update karein
        shiftDurationInput.addEventListener('input', () => {
            console.log('Shift duration changed.'); // Debugging log
            let value = parseFloat(shiftDurationInput.value);
            if (isNaN(value)) { // Handle empty input
                value = 0; // Or some default
            }

            if (value > 12) {
                shiftDurationInput.value = 12;
                showMessage('Shift duration cannot exceed 12 hours.');
            } else if (value < 1 && value !== 0) {
                shiftDurationInput.value = 1;
                showMessage('Shift duration cannot be less than 1 hour.');
            }
            updateLeavingTime();
            saveState();
        });

        // Manual IN time change hone par IN time update karein (agar IN nahi kiya hai)
        manualInTimeInput.addEventListener('change', () => {
            console.log('Manual IN time changed.'); // Debugging log
            if (!inTime) {
                updateUI();
            }
            saveState();
        });

        // Reset Manual IN Time button click handler
        resetManualInTimeBtn.addEventListener('click', () => {
            console.log('Reset Manual IN Time button clicked.'); // Debugging log
            manualInTimeInput.value = '';
            updateUI();
            saveState();
        });

        // Dark Mode Toggle handler
        darkModeToggle.addEventListener('click', () => {
            console.log('Dark Mode Toggle clicked.'); // Debugging log
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                body.classList.add('dark');
                darkModeIcon.textContent = '☀️'; // Sun icon for dark mode
            } else {
                body.classList.remove('dark');
                darkModeIcon.textContent = '🌙'; // Moon icon for light mode
            }
            saveState();
        });

        // View Reports Button handler
        viewReportsBtn.addEventListener('click', () => {
            console.log('View Reports button clicked.'); // Debugging log
            const wasHidden = reportsSection.classList.contains('hidden'); // Check state *before* toggling
            reportsSection.classList.toggle('hidden'); // Toggle visibility
            renderReports(); // Reports ko har baar dikhane par re-render karein

            if (wasHidden && !reportsSection.classList.contains('hidden')) { // Agar hidden se visible hua hai
                console.log('Reports section just became visible. Showing scroll message.');
                scrollMessage.classList.add('visible');
                // Remove the 'visible' class after 3 seconds
                setTimeout(() => {
                    scrollMessage.classList.remove('visible');
                    console.log('Scroll message hidden.');
                }, 3000);
            } else {
                // If the section was already visible or just hidden, hide the message
                console.log('Reports section was already visible or just hidden. Hiding scroll message.');
                scrollMessage.classList.remove('visible');
            }
        });

        // Apply Filter/Sort button handler
        applyFilterSortBtn.addEventListener('click', () => {
            console.log('Apply Filter/Sort button clicked.');
            renderReports(); // Re-render reports with current filter and sort options
        });

        // Clear All Reports button handler
        clearAllReportsBtn.addEventListener('click', clearAllReports);

        // Export Reports button handler
        exportReportsBtn.addEventListener('click', exportReportsToCSV);

        // Notification checkbox change handler
        enableNotificationsCheckbox.addEventListener('change', async () => {
            enableNotifications = enableNotificationsCheckbox.checked;
            reminderMinutesInput.disabled = !enableNotifications; // Enable/disable minutes input

            if (enableNotifications) {
                const granted = await requestNotificationPermission();
                if (!granted) {
                    enableNotificationsCheckbox.checked = false; // Uncheck if permission denied
                    enableNotifications = false;
                    reminderMinutesInput.disabled = true;
                }
            }
            saveState();
        });

        // Reminder minutes input change handler
        reminderMinutesInput.addEventListener('input', () => {
            let value = parseInt(reminderMinutesInput.value);
            if (isNaN(value) || value < 1) {
                reminderMinutesInput.value = 1;
                showMessage('Reminder minutes cannot be less than 1.');
            } else if (value > 60) {
                reminderMinutesInput.value = 60;
                showMessage('Reminder minutes cannot exceed 60.');
            }
            reminderMinutesBeforeOut = parseInt(reminderMinutesInput.value);
            saveState();
        });


        // Initial load: Local Storage se state load karein
        document.addEventListener('DOMContentLoaded', loadState);

        // Har second leaving time update karein
        setInterval(updateLeavingTime, 1000);
        
        // Service Worker Register karein
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
